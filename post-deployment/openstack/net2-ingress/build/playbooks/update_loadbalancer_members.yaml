---
- hosts: localhost
  connection: local
  gather_facts: no

  tasks:
  - name: 'Get net2 nodes'
    community.kubernetes.k8s_info:
      kind: Node
      label_selectors:
        - node-role.kubernetes.io/net2 =
    register: net2Nodes

  - name: 'Extract net2 node IPs'
    set_fact:
      net2MembersRaw: "{{ net2Nodes | to_json | from_json | json_query(net2MembersRawQuery) }}"
    vars:
      net2MembersRawQuery: "resources[*].status.addresses[?type=='InternalIP'].address"

  - name: 'Build net2 node IP dict'
    set_fact:
      net2Members: "{{ net2Members | default([]) + [ item ] }}"
    with_items: "{{ net2MembersRaw }}"

  - name: 'Get loadbalancer pools'
    command:
      cmd: openstack loadbalancer pool list -c name -f value
    register: loadbalancerPoolsRaw

  - name: Sanitise loadbalancer pools
    set_fact:
      loadbalancerPools: "{{ loadbalancerPoolsRaw.stdout_lines }}"

  - name: 'Get loadbalancer pool members'
    command:
      cmd: openstack loadbalancer member list "{{ loadbalancerPools | first }}" -c address -f value
    register: loadbalancerMembersRaw

  - name: 'Sanitise loadbalancer pool members'
    set_fact:
      loadbalancerMembers: "{{ loadbalancerMembersRaw.stdout_lines }}"

  - name: 'Determine members to be added'
    set_fact:
      loadbalancerMembersToAdd: "{{ loadbalancerMembersToAdd | default([]) + [ item ] }}"
    with_items: "{{ net2Members }}"
    when: item not in loadbalancerMembers

  - name: 'Determine members to be deleted'
    set_fact:
      loadbalancerMembersToDelete: "{{ loadbalancerMembersToDelete | default([]) + [ item ] }}"
    with_items: "{{ loadbalancerMembers }}"
    when: item not in net2Members

  - name: 'Add loadbalancer members'
    openstack.cloud.lb_member:
      name: "{{ item[1] }}"
      address: "{{ item[1] }}"
      pool: "{{ item[0] }}"
      protocol_port: "{{ 443 if '-HTTPS-' in item[0] else 80 }}"
      state: present
    with_nested:
      - "{{ loadbalancerPools }}"
      - "{{ loadbalancerMembersToAdd }}"
    when: loadbalancerMembersToAdd is defined

  - name: 'Delete loadbalancer members'
    openstack.cloud.lb_member:
      name: "{{ item[1] }}"
      pool: "{{ item[0] }}"
      state: absent
    with_nested:
      - "{{ loadbalancerPools }}"
      - "{{ loadbalancerMembersToDelete }}"
    when: loadbalancerMembersToDelete is defined
