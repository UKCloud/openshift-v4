# Stage 2 container build

Procedure below builds the containers and also pushes the new version (\<tagversion\>) to a registry

```
$ podman login --tls-verify=false exampleregistry.domain.local:5002/docker-openshift
$ ./build.sh
Enter the image tag version to build - this should be entered as "imagetag" in config.json:
<tagversion>
Enter the registry url prefix (without trailing /):
exampleregistry.domain.local:5002/docker-openshift
...
```

To deploy this version, "imagetag" in `config.json` should be set to <tagversion>



# Stage 2 containers

These containers are ran on the bastion created by Stage 1 (typically automatically, ran by the `/usr/local/bin/stage2-containers.sh` script which is triggered as a oneshot systemd service called `stage2-containers.service`)

## 4.run-installer
This runs `openshift-install` command. By default it uses the version of `openshift-install` which is embedded into the container at install time; however, if `openshift-install` exists in the deployconfig directory, it is used in preference. This allows the disconnected install version of `openshift-install` to be utilised instead.

## 5.ign-webserver
This is an nginx webserver which is used to host the bootstrap.ign file (generated by 4.run-installer) while the bootstrap machine is booted. It is started by `stage2-containers.sh` after 4.run-installer completes and remains running for 10 minutes. After which, the webserver container is stopped and deleted.

## 6.add-ignition
This container takes the contents of the master.ign and worker.ign files etc (generated by 4.run-installer) plus the URL of the bootstrap ign-webserver and adds them as fields in `config.json` so that the terraform deploy can use them.

## 7.run-terraform
This runs the actual terraform that creates bootstrap, masters, workers, and svcs vms. 

## 8.configure-svcs
This ansible-based container configures a core user on the RHEL svc VMs, registers them with satellite, installs packages and then configures and installs CoreDNS on them as a systemd service to make them act as internal cluster DNS.
